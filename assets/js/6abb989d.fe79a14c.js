"use strict";(self.webpackChunk_honestfoodcompany_pubsub=self.webpackChunk_honestfoodcompany_pubsub||[]).push([[9692],{3905:(e,t,i)=>{i.d(t,{Zo:()=>p,kt:()=>b});var r=i(7294);function n(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function a(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function o(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?a(Object(i),!0).forEach((function(t){n(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):a(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function s(e,t){if(null==e)return{};var i,r,n=function(e,t){if(null==e)return{};var i,r,n={},a=Object.keys(e);for(r=0;r<a.length;r++)i=a[r],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)i=a[r],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var l=r.createContext({}),c=function(e){var t=r.useContext(l),i=t;return e&&(i="function"==typeof e?e(t):o(o({},t),e)),i},p=function(e){var t=c(e.components);return r.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var i=e.components,n=e.mdxType,a=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),d=c(i),b=n,m=d["".concat(l,".").concat(b)]||d[b]||u[b]||a;return i?r.createElement(m,o(o({ref:t},p),{},{components:i})):r.createElement(m,o({ref:t},p))}));function b(e,t){var i=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var a=i.length,o=new Array(a);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:n,o[1]=s;for(var c=2;c<a;c++)o[c]=i[c];return r.createElement.apply(null,o)}return r.createElement.apply(null,i)}d.displayName="MDXCreateElement"},7945:(e,t,i)=>{i.r(t),i.d(t,{frontMatter:()=>s,contentTitle:()=>l,metadata:()=>c,toc:()=>p,default:()=>d});var r=i(7462),n=i(3366),a=(i(7294),i(3905)),o=["components"],s={id:"dead-letter-policy",title:"Subscriptions with a Dead-letter Policy",sidebar_label:"Dead Letter Policy",sidebar_position:1},l=void 0,c={unversionedId:"subscribing/dead-letter-policy",id:"subscribing/dead-letter-policy",isDocsHomePage:!1,title:"Subscriptions with a Dead-letter Policy",description:"It is possible to define a dead-letter policy for a subscription. If the dead letter topic does not exist, it will be created automatically by the framework.",source:"@site/docs/subscribing/Dead Letter Policy.md",sourceDirName:"subscribing",slug:"/subscribing/dead-letter-policy",permalink:"/hfc-pubsub/subscribing/dead-letter-policy",editUrl:"https://github.com/deliveryhero/hfc-pubsub/edit/main/docs/subscribing/Dead Letter Policy.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"dead-letter-policy",title:"Subscriptions with a Dead-letter Policy",sidebar_label:"Dead Letter Policy",sidebar_position:1},sidebar:"defaultSidebar",previous:{title:"Subscriptions",permalink:"/hfc-pubsub/subscribing/subscriptions"},next:{title:"Error Handling",permalink:"/hfc-pubsub/subscribing/error-handling"}},p=[{value:"Binding Subscriber and Publisher role",id:"binding-subscriber-and-publisher-role",children:[],level:2},{value:"Checking for subscribers to DLQ topic",id:"checking-for-subscribers-to-dlq-topic",children:[{value:"Automatically creating default subscribers",id:"automatically-creating-default-subscribers",children:[],level:3}],level:2}],u={toc:p};function d(e){var t=e.components,i=(0,n.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},u,i,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"It is possible to define a dead-letter policy for a subscription. If the dead letter topic does not exist, it will be created automatically by the framework."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="/pubsub/subscriptions/simple.topic.sub.js',title:'"/pubsub/subscriptions/simple.topic.sub.js'},"exports.default = {\n  topicName: 'test.topic',\n  subscriptionName: 'test.topic.sub',\n  description: 'Will console log messages published on test.topic',\n  options: {\n    deadLetterPolicy: {\n      deadLetterTopic: 'test.topic.sub.dlq',\n      maxDeliveryAttempts: 15,\n      createDefaultSubscription: true,\n    },\n  },\n  handleMessage: function (message) {\n    console.log(`received a message on ${this.subscriptionName}`);\n    console.log(message.data.toString());\n  },\n};\n")),(0,a.kt)("h2",{id:"binding-subscriber-and-publisher-role"},"Binding Subscriber and Publisher role"),(0,a.kt)("p",null,"The framework will automatically attach a Publisher & Subscriber role to your dead letter queue, just add a DLQ config and make sure your service account has the roles defined ",(0,a.kt)("a",{parentName:"p",href:"../Guides/Drivers#google-pubsub-driver"},"here"),"."),(0,a.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,a.kt)("div",{parentName:"div",className:"admonition-heading"},(0,a.kt)("h5",{parentName:"div"},(0,a.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,a.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,a.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,a.kt)("div",{parentName:"div",className:"admonition-content"},(0,a.kt)("p",{parentName:"div"},"  Binding the above policies don't require current subscriptions to be deleted and recreated."))),(0,a.kt)("p",null,"This is following the ",(0,a.kt)("a",{parentName:"p",href:"https://cloud.google.com/pubsub/docs/handling-failures#granting_forwarding_permissions"},"best practices defined by Google here")),(0,a.kt)("h2",{id:"checking-for-subscribers-to-dlq-topic"},"Checking for subscribers to DLQ topic"),(0,a.kt)("p",null,"A dead letter topic is not useful without a subscription for it, because without it all messages are just lost to the void."),(0,a.kt)("p",null,"To avoid this scenario, we automatically check for subscriptions on the DLQ topic and warn in case the DLQ topic ",(0,a.kt)("strong",{parentName:"p"},"doesn't have any subscriptions"),". Example warning:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sh"},"Please set createDefaultSubscription: true in deadLetterPolicy to create default subscriber for dead letter topic of simple.topic.console-log.subscription-with-options. Ignore if already added subscription for it.\n")),(0,a.kt)("h3",{id:"automatically-creating-default-subscribers"},"Automatically creating default subscribers"),(0,a.kt)("p",null,"To make it easy to set this up, we have a option ",(0,a.kt)("inlineCode",{parentName:"p"},"createDefaultSubscription")," that will automatically create a default dead letter subscription with name having ",(0,a.kt)("inlineCode",{parentName:"p"},".default")," added to the ",(0,a.kt)("inlineCode",{parentName:"p"},"deadLetterTopic"),"."),(0,a.kt)("p",null,"For example, if deadLetterTopic is ",(0,a.kt)("inlineCode",{parentName:"p"},"example.test.dlq")," then a subscription called ",(0,a.kt)("inlineCode",{parentName:"p"},"example.test.dlq.default")," will be automatically created if ",(0,a.kt)("inlineCode",{parentName:"p"},"createDefaultSubscription")," is true."))}d.isMDXComponent=!0}}]);