"use strict";(self.webpackChunk_honestfoodcompany_pubsub=self.webpackChunk_honestfoodcompany_pubsub||[]).push([[869],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>d});var i=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function s(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?s(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function a(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},s=Object.keys(e);for(i=0;i<s.length;i++)t=s[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)t=s[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=i.createContext({}),u=function(e){var n=i.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=u(e.components);return i.createElement(c.Provider,{value:n},e.children)},l={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},b=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,s=e.originalType,c=e.parentName,p=a(e,["components","mdxType","originalType","parentName"]),b=u(t),d=r,f=b["".concat(c,".").concat(d)]||b[d]||l[d]||s;return t?i.createElement(f,o(o({ref:n},p),{},{components:t})):i.createElement(f,o({ref:n},p))}));function d(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var s=t.length,o=new Array(s);o[0]=b;var a={};for(var c in n)hasOwnProperty.call(n,c)&&(a[c]=n[c]);a.originalType=e,a.mdxType="string"==typeof e?e:r,o[1]=a;for(var u=2;u<s;u++)o[u]=t[u];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}b.displayName="MDXCreateElement"},6514:(e,n,t)=>{t.r(n),t.d(n,{frontMatter:()=>a,contentTitle:()=>c,metadata:()=>u,toc:()=>p,default:()=>b});var i=t(3117),r=t(102),s=(t(7294),t(3905)),o=["components"],a={id:"service",title:"Subscription Service",sidebar_position:4},c=void 0,u={unversionedId:"Getting Started/service",id:"Getting Started/service",isDocsHomePage:!1,title:"Subscription Service",description:"Extend and customize the behavior of the subscription server in the subscription.service file. Initialize a database connection, register subscribers, and define default subscriber options in the subscription service file.",source:"@site/docs/Getting Started/Service.md",sourceDirName:"Getting Started",slug:"/Getting Started/service",permalink:"/hfc-pubsub/Getting Started/service",editUrl:"https://github.com/deliveryhero/hfc-pubsub/edit/main/docs/docs/Getting Started/Service.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{id:"service",title:"Subscription Service",sidebar_position:4},sidebar:"defaultSidebar",previous:{title:"Subscriptions",permalink:"/hfc-pubsub/Getting Started/subscriptions"},next:{title:"CLI",permalink:"/hfc-pubsub/Getting Started/cli"}},p=[{value:"Typescript example",id:"typescript-example",children:[]},{value:"Javascript Example",id:"javascript-example",children:[]},{value:"Options",id:"options",children:[{value:"Passing a custom Logger",id:"passing-a-custom-logger",children:[]},{value:"Connecting to a database",id:"connecting-to-a-database",children:[]},{value:"Graceful Shutdown",id:"graceful-shutdown",children:[]}]}],l={toc:p};function b(e){var n=e.components,t=(0,r.Z)(e,o);return(0,s.kt)("wrapper",(0,i.Z)({},l,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("p",null,"Extend and customize the behavior of the subscription server in the ",(0,s.kt)("inlineCode",{parentName:"p"},"subscription.service")," file. Initialize a database connection, register subscribers, and ",(0,s.kt)("strong",{parentName:"p"},"define default subscriber")," options in the subscription service file."),(0,s.kt)("h2",{id:"typescript-example"},"Typescript example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="/pubsub/subscription.service.ts"',title:'"/pubsub/subscription.service.ts"'},"import * as PubSub from '@honestfoodcompany/pubsub';\nimport { SubscriberOptions } from '@honestfoodcompany/pubsub';\n\n/**\n * This function call is optional, you can pass an instance of Pino, Winston logger\n * By default it uses default console.* for logging\n * The logger you pass must support .error, .info and .warn methods for it to work\n */\nPubSub.setLogger(console);\n\nexport default class SubscriptionService extends PubSub.SubscriptionService {\n  static subscribers = [\n    /**\n     * if your subscribers don't have the .sub.js suffix\n     * they won't be auto-loaded,  so you can include their default\n     * export in  this array\n     */\n  ];\n\n  static defaultSubscriberOptions: SubscriberOptions = {\n    /**\n     * Define project level default subscriber options here.\n     * These options can be overridden by options defined in subscribers\n     */\n  };\n\n  static async init(): Promise<void> {\n    /**\n     * This function is called when the subscription server starts.\n     * This is a good place to initialize a database connection\n     */\n  }\n}\n")),(0,s.kt)("h2",{id:"javascript-example"},"Javascript Example"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js",metastring:'title="/pubsub/subscription.service.js"',title:'"/pubsub/subscription.service.js"'},"const PubSub = require('@honestfoodcompany/pubsub');\n\nclass SubscriptionService extends PubSub.SubscriptionService {}\n\nSubscriptionService.subscribers = [\n  /**\n   * if your subscribers don't have the .sub.js suffix\n   * they won't be auto-loaded,  so you can include their default\n   * export in  this array\n   */\n];\n\nSubscriptionService.defaultSubscriberOptions = {\n  /**\n   * Define project-level default subscriber options here.\n   * These options can be overridden by options defined in subscribers\n   */\n};\n\nSubscriptionService.init = () => {\n  /**\n   * This function is called when the subscription server starts.\n   * This is a good place to initialize a database connection\n   */\n};\n\nexports.default = SubscriptionService;\n")),(0,s.kt)("h2",{id:"options"},"Options"),(0,s.kt)("h3",{id:"passing-a-custom-logger"},"Passing a custom Logger"),(0,s.kt)("p",null,"In the main SubscriptionService before defining subscription class you can update the logger that is being used by the package for logging. It's an optional definition and by default it uses ",(0,s.kt)("inlineCode",{parentName:"p"},"console.*")," for logging ",(0,s.kt)("inlineCode",{parentName:"p"},".info"),", ",(0,s.kt)("inlineCode",{parentName:"p"},".warn")," and ",(0,s.kt)("inlineCode",{parentName:"p"},".error")," these 3 function keys are a must have for the logger you pass."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts"},"import { setLogger } from '@honestfoodcompany/pubsub';\nsetLogger(console);\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-js"},"const { setLogger } = require('@honestfoodcompany/pubsub');\nsetLogger(console);\n")),(0,s.kt)("h3",{id:"connecting-to-a-database"},"Connecting to a database"),(0,s.kt)("p",null,"It is recommended to initialize a database connection in the ",(0,s.kt)("inlineCode",{parentName:"p"},"subscription.service")," file in your ",(0,s.kt)("inlineCode",{parentName:"p"},"PUBSUB_ROOT_DIR"),". Insert your database connection logic in the ",(0,s.kt)("inlineCode",{parentName:"p"},"init")," method."),(0,s.kt)("h3",{id:"graceful-shutdown"},"Graceful Shutdown"),(0,s.kt)("p",null,"When gracefully shutting down a process, it is a good idea to first close all open subscriptions. For this reason we have a static ",(0,s.kt)("inlineCode",{parentName:"p"},"closeAll")," method in the ",(0,s.kt)("inlineCode",{parentName:"p"},"SubscriptionService")," that can close all connections before shutting down. An example using it with process signal handlers:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-ts",metastring:'{28-41} title="/pubsub/subscription.service.ts"',"{28-41}":!0,title:'"/pubsub/subscription.service.ts"'},"import * as PubSub from '@honestfoodcompany/pubsub';\nimport mongoose from 'mongoose';\nimport { SubscriberOptions } from '@honestfoodcompany/pubsub';\n\nexport default class SubscriptionService extends PubSub.SubscriptionService {\n  static subscribers = [\n    /**\n     * if your subscribers don't have the .sub.js suffix\n     * they won't be auto-loaded,  so you can include their default\n     * export in  this array\n     */\n  ];\n\n  /**\n   * This function is called when the subscription server starts.\n   */\n  static async init(): Promise<void> {\n    /**\n     * This is a good place to initialize a database connection\n     */\n    await mongoose.connect();\n  }\n}\n\n/**\n * Example setting up graceful shutdown\n */\nprocess.on('SIGTERM', () => {\n  // First close all subscriptions\n  SubscriptionService.closeAll()\n    .then(() => {\n      // Then the databse so no new handlers are triggered\n      mongoose.disconnect(() => {\n        process.exit(0);\n      });\n    })\n    .catch((err) => {\n      console.error(err, 'Could not close subscriptions');\n      process.exit(1); // Exit with error\n    });\n});\n")))}b.isMDXComponent=!0}}]);